<Project TreatAsLocalProperty="_MvcFrontendKitTaskFolder">

  <!-- Detect MSBuild runtime and select appropriate task assembly -->
  <PropertyGroup>
    <!-- dotnet build (.NET Core) uses net9.0 -->
    <_MvcFrontendKitTaskFolder Condition="'$(MSBuildRuntimeType)' == 'Core'">net9.0</_MvcFrontendKitTaskFolder>
    <!-- MSBuild.exe (.NET Framework) uses net472 -->
    <_MvcFrontendKitTaskFolder Condition="'$(MSBuildRuntimeType)' != 'Core'">net472</_MvcFrontendKitTaskFolder>
  </PropertyGroup>

  <!-- Load the MSBuild task assembly based on runtime -->
  <UsingTask TaskName="MvcFrontendKit.Build.FrontendBundleTask"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tasks\$(_MvcFrontendKitTaskFolder)\MvcFrontendKit.Build.dll" />

  <!-- Hook into the Build process for Release configuration -->
  <Target Name="MvcFrontendKitBuild"
          BeforeTargets="Build"
          Condition="'$(MvcFrontendKitEnabled)' == 'true' AND ('$(Configuration)' == 'Release' OR '$(MvcFrontendKitSkipOnDebug)' != 'true')">

    <Message Text="MvcFrontendKit: Bundling frontend assets..." Importance="high" />
    <Message Text="  Config: $(MvcFrontendKitConfigPath)" Importance="normal" />
    <Message Text="  Manifest: $(MvcFrontendKitManifestPath)" Importance="normal" />
    <Message Text="  Task Assembly: $(_MvcFrontendKitTaskFolder)" Importance="low" />

    <!-- Check if config file exists -->
    <Error Condition="!Exists('$(MvcFrontendKitConfigPath)')"
           Text="MvcFrontendKit: Config file not found at '$(MvcFrontendKitConfigPath)'. Run 'dotnet frontend init' to create it, or set MvcFrontendKitEnabled=false to disable bundling." />

    <!-- Invoke the bundling task -->
    <FrontendBundleTask ProjectDirectory="$(MSBuildProjectDirectory)"
                        ConfigPath="$(MvcFrontendKitConfigPath)" />

  </Target>

  <!-- Hook into Publish to ensure bundles are included -->
  <Target Name="MvcFrontendKitPublish"
          BeforeTargets="Publish"
          Condition="'$(MvcFrontendKitEnabled)' == 'true'">

    <Message Text="MvcFrontendKit: Preparing frontend assets for publish..." Importance="high" />

    <!-- Ensure the bundling has run -->
    <CallTarget Targets="MvcFrontendKitBuild" />

  </Target>

</Project>
