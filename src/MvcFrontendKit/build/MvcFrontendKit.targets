<Project TreatAsLocalProperty="_MvcFrontendKitTaskFolder">

  <!-- Detect MSBuild runtime and select appropriate task assembly -->
  <PropertyGroup>
    <!-- dotnet build (.NET Core) uses net9.0 -->
    <_MvcFrontendKitTaskFolder Condition="'$(MSBuildRuntimeType)' == 'Core'">net9.0</_MvcFrontendKitTaskFolder>
    <!-- MSBuild.exe (.NET Framework) uses net472 -->
    <_MvcFrontendKitTaskFolder Condition="'$(MSBuildRuntimeType)' != 'Core'">net472</_MvcFrontendKitTaskFolder>
  </PropertyGroup>

  <!-- Load the MSBuild task assembly based on runtime -->
  <UsingTask TaskName="MvcFrontendKit.Build.FrontendBundleTask"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tasks\$(_MvcFrontendKitTaskFolder)\MvcFrontendKit.Build.dll" />

  <!--
    EARLY CLEANUP: Remove stale dist files BEFORE any StaticWebAssets discovery.

    This target runs at the very beginning of the build process to remove
    any existing hashed files in wwwroot/dist from previous builds. This prevents
    StaticWebAssets from discovering and registering stale files that will be
    replaced with different hashes when we bundle.

    Without this early cleanup, the following happens:
    1. Previous build created global.OLDHASH.css
    2. New build starts, SDK discovers and registers global.OLDHASH.css
    3. MvcFrontendKitBuild runs, creates global.NEWHASH.css (content changed = new hash)
    4. SDK looks for global.OLDHASH.css which no longer exists -> BUILD FAILS

    By cleaning early, we ensure:
    1. Dist is empty when SDK runs any asset discovery
    2. MvcFrontendKitBuild creates fresh files
    3. SDK discovers only the new files with correct hashes
  -->
  <Target Name="MvcFrontendKitCleanDist"
          BeforeTargets="BeforeBuild;PrepareForBuild;ResolveAssemblyReferences"
          Condition="'$(MvcFrontendKitEnabled)' == 'true' AND '$(_IsPublishing)' != 'true' AND ('$(Configuration)' == 'Release' OR '$(MvcFrontendKitSkipOnDebug)' != 'true')">

    <PropertyGroup>
      <_MvcFrontendKitDistPath>$(MSBuildProjectDirectory)\wwwroot\dist</_MvcFrontendKitDistPath>
    </PropertyGroup>

    <!-- Only clean if dist exists and contains files -->
    <Message Condition="Exists('$(_MvcFrontendKitDistPath)')"
             Text="MvcFrontendKit: Cleaning stale dist files before build..."
             Importance="normal" />

    <RemoveDir Directories="$(_MvcFrontendKitDistPath)"
               Condition="Exists('$(_MvcFrontendKitDistPath)')" />

  </Target>

  <!--
    Hook into the Build process BEFORE StaticWebAssets discovery.

    Target ordering for ASP.NET Core web apps:
    1. MvcFrontendKitCleanDist (our early cleanup) - removes stale dist files
    2. PrepareForBuild
    3. ResolveProjectReferences
    4. MvcFrontendKitBuild (our target) - creates wwwroot/dist files
    5. ResolveStaticWebAssetsInputs - discovers wwwroot files including our bundles
    6. GenerateStaticWebAssetsManifest - creates staticwebassets.build.json
    7. Build completion

    CRITICAL: We must run BEFORE ResolveStaticWebAssetsInputs so that our
    generated bundles in wwwroot/dist are included in the static web assets manifest.

    IMPORTANT: We must NOT run during Publish phase. The bundles are created during Build
    and the StaticWebAssets system references them by hash. Re-bundling during Publish
    creates different hashes, breaking the manifest references.

    Detection: During Publish, _IsPublishing is set to true by the SDK.
  -->
  <Target Name="MvcFrontendKitBuild"
          AfterTargets="ResolveProjectReferences"
          BeforeTargets="ResolveStaticWebAssetsInputs;AssignTargetPaths"
          Condition="'$(MvcFrontendKitEnabled)' == 'true' AND '$(_IsPublishing)' != 'true' AND ('$(Configuration)' == 'Release' OR '$(MvcFrontendKitSkipOnDebug)' != 'true')">

    <Message Text="MvcFrontendKit: Bundling frontend assets..." Importance="high" />
    <Message Text="  Config: $(MvcFrontendKitConfigPath)" Importance="normal" />
    <Message Text="  Manifest: $(MvcFrontendKitManifestPath)" Importance="normal" />
    <Message Text="  Task Assembly: $(_MvcFrontendKitTaskFolder)" Importance="low" />

    <!-- Check if config file exists -->
    <Error Condition="!Exists('$(MvcFrontendKitConfigPath)')"
           Text="MvcFrontendKit: Config file not found at '$(MvcFrontendKitConfigPath)'. Run 'dotnet frontend init' to create it, or set MvcFrontendKitEnabled=false to disable bundling." />

    <!-- Invoke the bundling task -->
    <FrontendBundleTask ProjectDirectory="$(MSBuildProjectDirectory)"
                        ConfigPath="$(MvcFrontendKitConfigPath)" />

    <!--
      After bundling, we need to ensure the new files in wwwroot/dist are
      picked up by StaticWebAssets. Include them as Content items.
    -->
    <ItemGroup>
      <Content Include="$(MSBuildProjectDirectory)\wwwroot\dist\**\*"
               Condition="Exists('$(MSBuildProjectDirectory)\wwwroot\dist')"
               CopyToOutputDirectory="PreserveNewest"
               CopyToPublishDirectory="PreserveNewest" />
      <Content Include="$(MvcFrontendKitManifestPath)"
               Condition="Exists('$(MvcFrontendKitManifestPath)')"
               CopyToOutputDirectory="PreserveNewest"
               CopyToPublishDirectory="PreserveNewest" />
    </ItemGroup>

  </Target>

  <!--
    Publish target: Verify bundles exist but do NOT re-bundle.

    The bundles were created during Build and are referenced by hash in
    staticwebassets.build.json. Re-bundling would create different hashes
    and break the StaticWebAssets manifest.

    This target only verifies the bundles exist and logs a message.
    The actual inclusion of bundles is handled by StaticWebAssets from the Build phase.
  -->
  <Target Name="MvcFrontendKitPublish"
          BeforeTargets="PrepareForPublish"
          Condition="'$(MvcFrontendKitEnabled)' == 'true'">

    <Message Text="MvcFrontendKit: Using frontend assets from build phase..." Importance="high" />

    <!-- Verify the manifest exists from Build phase -->
    <Warning Condition="!Exists('$(MvcFrontendKitManifestPath)')"
             Text="MvcFrontendKit: frontend.manifest.json not found. Run 'dotnet build -c Release' before publish." />

  </Target>

</Project>
